name: Make release
description: Make release

inputs:
  tag_name:
    description: Set product to compile
    required: true
    type: string
  target_name:
    description: Set chipcode module to compile
    required: true
    type: string
  branch:
    required: true
    type: string
  hardware_version:
    required: true
    type: string

runs:
  using: composite
  steps:
    - run: |
        echo "tag_name=${{ inputs.tag_name }}"
        echo "target_name=${{ inputs.target_name }}"
        echo "sudo chown $(whoami) -R $(pwd)"
        sudo chown $(whoami) -R $(pwd)
      shell: bash
    - uses: actions/checkout@v3
      with:
        ref: ${{ inputs.branch }}
        fetch-depth: 1
        lfs: true
    - run: |
        git fetch origin feature/github_workflow
        git checkout origin/feature/github_workflow -- .github build
      shell: bash
    - run: |
        git config user.name "Cavli Server"
        git config user.email "cavliserver@cavliwireless.com"
        echo "Cherry Pick commit to disable RAMDUMP"
        git cherry-pick 1a7f2024bb1139e48e1f1e85762c57b2b3a84f0c
    - run: |
        bash build/build.sh ${{ inputs.tag_name }} ${{ inputs.hardware_version }} ${{ inputs.target_name }} all release
        tar -vczf mdm9607_release_${{ inputs.target_name }}_${{ inputs.hardware_version }}_${{ inputs.tag_name }}.tgz binaries_out
      shell: bash
    - run: |
        echo "${{ github.token }}" > .token.txt
        gh auth login --with-token < .token.txt
        gh release upload ${{ inputs.tag_name }} mdm9607_release_*.tgz --clobber
        gh auth logout -u github-actions[bot]
        rm .token.txt
      shell: bash
      env:
        GH_TOKEN: ${{ env.GH_TOKEN }}
